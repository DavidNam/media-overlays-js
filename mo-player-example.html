<!doctype html>
<html>
    <head>
        <title>Media Overlays Experiments</title>
        
        <script src="lib/jquery-1.7.1.min.js"></script>
        <script src="lib/underscore-min.js"></script>
        <script src="lib/backbone-min.js"></script>
        
        <script src="media-overlays.js"></script>
        <script>
        
        //SMIL_URL = "http://localhost:4000/testdata/valentin/epub/Publication/Content/valentinhauy.smil";
        SMIL_URL = "http://localhost:4000/testdata/numbers/numbers.smil";
        //SMIL_URL = "http://localhost:4000/testdata/alphabet/alphabet.smil";
        RANDOM_TEXT_SRC = "valentinhauy.xhtml#rgn_cnt_0116";
        
        $(document).ready(function() {
            model = new MediaOverlay();
            controlsview = new Controls({model: model, el: $("#controls")});  
            textview = new TextArea({model: model, el: $("#textarea")});
        });
        
        Controls = Backbone.View.extend({
            loaded: false,
            shouldJump: false,
            startNode: null,
            events: {
                'click #playpause': 'playpause',
                'click #jump': 'jump',
                'change #volume': 'setvolume'
            },
            
            initialize: function() {
                var self = this;
                this.model.bind('change:is_playing', function() {self.render()});
                this.model.bind('change:is_ready', function() {
                   self.loaded = true; 
                });
            },
            
            render: function() {
                if (this.model.get("is_playing")) {
                    $("#playpause").text("pause");
                    $("#cb").attr('disabled', 'disabled');
                }
                else {
                    $("#playpause").text("play");
                    $("#cb").removeAttr('disabled');
                }
                return this;
            },
            
            playpause: function() {
                var self = this;
                // load a file if we haven't already
                if (this.loaded == false) {
                    this.model.bind("change:is_ready", onready);
                    function onready() {
                        self.model.unbind("change:is_ready", onready);
                        self.model.play(null); 
                    }
                    this.model.fetch({url: SMIL_URL});
                }
                else {
                    if (this.model.get("is_playing")) {
                        this.model.pause();
                    }
                    else {
                        this.model.resume();
                    }
                }
            },
            jump: function() {
                var self = this;
                // load a file if we haven't already
                if (this.loaded == false) {
                    this.model.bind("change:is_ready", onready);
                    function onready() {
                        self.model.unbind("change:is_ready", onready);
                        self.startNode = self.model.findNodeByTextSrc(RANDOM_TEXT_SRC);
                        self.model.play(self.startNode);
                    }
                    this.model.fetch({url: SMIL_URL});
                }   
                else {
                    this.model.pause();
                    self.startNode = self.model.findNodeByTextSrc(RANDOM_TEXT_SRC);
                    self.model.play(self.startNode);
                }
            },
            setvolume: function() {
                this.model.setVolume($("#volume")[0].value/100);
            }
        });
        
        

        TextArea = Backbone.View.extend({
            lastid: null,
            
            initialize: function() {
                var self = this;
                this.model.bind('change:current_text_document_url', function() {self.loadText()});
                this.model.bind('change:current_text_element_id', function() {self.highlight()});
                this.model.bind('change:is_document_done', function() {
                    if (self.model.get("is_document_done")) {
                        console.log("document is done")
                    }
                });
            },
           
           loadText: function() {
               var textdoc = this.model.get("current_text_document_url");
               var fullurl = MediaOverlay.Utils.resolveUrl(textdoc, SMIL_URL);
               if ($("#textarea").attr("src") != fullurl) {
                    $("#textarea").attr("src", MediaOverlay.Utils.resolveUrl(textdoc, SMIL_URL));
               }
           },
           
           // highlight the new ID and unhighlight the old one
           // the right way to manage highlighting is to use toggleClass, but for some reason, that's not working in this iframe...
           // and for this demo, it's not really crucial to get it right.  this is just an example of how you could listen to the text element ID changing.
           highlight: function() {
               var id = this.model.get("current_text_element_id");
               if (this.model.get("should_highlight")) {
                   if (this.lastid != null) {
                       // undo the background color change
                       // getTextElm(this.lastid).toggleClass("highlight");
                       // this works when you do it manually via js command line but not at runtime ... what's going on?
                       getTextElm(this.lastid).css("background-color", "");
                   }
                   var elm = getTextElm(id);
                   // dumb implementation: doesn't wait for iframe to load before highlighting
                   // we might miss the first highlight
                   if (elm.length > 0) {
                       elm[0].scrollIntoView();
                       //elm.toggleClass("highlight");
                       elm.css("background-color", "yellow");
                       this.lastid = id;
                   }
                   
                   function getTextElm(elmId) {
                       return $("#textarea").contents().find("#" + id);
                   }
               }
           }
        });      
        </script>
        <style>
            #textarea {
                width: 80%;
                height: 500px;
            }
            #controls > * {
                margin-right: 10px;
                margin-bottom: 10px;
            }   
            .highlight {
                background-color: yellow;
            }     
        </style>
    </head>
    <body id="view">
        <h1>Media Overlays Playback Simulation</h1>
        <div id="controls">
            <button id="playpause">play</button>
            <button id="jump">jump</button>
            <input id="volume" type="range"  min="0" max="100">Volume</input>
        </div>
        <iframe id="textarea"></iframe>
    </body>
</html>
